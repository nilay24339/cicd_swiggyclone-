pipeline {
  agent any

  tools {
    jdk 'jdk21'
  }

  environment {
    SCANNER_HOME = tool 'sonar-scanner'

    // Sonar projects (split: App + IaC)
    SONAR_APP_KEY  = 'swiggy-app'
    SONAR_APP_NAME = 'Swiggy-App'
    SONAR_IAC_KEY  = 'swiggy-iac'
    SONAR_IAC_NAME = 'Swiggy-IaC'

    AWS_REGION   = 'ap-south-1'
    CLUSTER_NAME = 'virtualtechbox-cluster'
    NAMESPACE    = 'swiggy'

    // build-specific tag so every deployment is unique
    DOCKER_IMAGE = "nilay2497/swiggy-clone:${BUILD_NUMBER}"
  }

  stages {

    stage('Clean Workspace') {
      steps {
        cleanWs()
      }
    }

    stage('Checkout') {
      steps {
        git branch: 'main', url: 'https://github.com/nilay24339/cicd_swiggyclone-.git'
      }
    }

    stage('Node Setup + Install Dependencies') {
      steps {
        script {
          def nodeHome = tool name: 'Node16', type: 'jenkins.plugins.nodejs.tools.NodeJSInstallation'
          env.PATH = "${nodeHome}/bin:${env.PATH}"
        }
        sh '''
          node -v
          npm -v
          npm ci || npm install
        '''
      }
    }

    // =========================================================
    // SONAR 1: APP (React)
    // =========================================================
    stage('SonarQube - App Scan') {
      steps {
        withSonarQubeEnv('SonarQube-Server') {
          // If you use ONE sonar token for all projects, you can remove withCredentials and -Dsonar.login
          withCredentials([string(credentialsId: 'sonar-token-app', variable: 'SONAR_TOKEN')]) {
            sh '''
              ${SCANNER_HOME}/bin/sonar-scanner \
                -Dsonar.host.url=$SONAR_HOST_URL \
                -Dsonar.login=$SONAR_TOKEN \
                -Dsonar.projectKey=${SONAR_APP_KEY} \
                -Dsonar.projectName=${SONAR_APP_NAME} \
                -Dsonar.sources=src,public \
                -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/build/**,**/.git/**,terraform/**,Kubernetes/**
            '''
          }
        }
      }
    }

    stage('Quality Gate - App') {
      steps {
        timeout(time: 5, unit: 'MINUTES') {
          waitForQualityGate abortPipeline: true
        }
      }
    }

    // =========================================================
    // SONAR 2: IaC (Terraform + Kubernetes) - non-blocking
    // =========================================================
    stage('SonarQube - IaC Scan') {
      steps {
        withSonarQubeEnv('SonarQube-Server') {
          withCredentials([string(credentialsId: 'sonar-token-iac', variable: 'SONAR_TOKEN')]) {
            sh '''
              ${SCANNER_HOME}/bin/sonar-scanner \
                -Dsonar.host.url=$SONAR_HOST_URL \
                -Dsonar.login=$SONAR_TOKEN \
                -Dsonar.projectKey=${SONAR_IAC_KEY} \
                -Dsonar.projectName=${SONAR_IAC_NAME} \
                -Dsonar.sources=terraform,Kubernetes \
                -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/build/**,**/.git/**,src/**,public/**
            '''
          }
        }
      }
    }

    stage('Quality Gate - IaC (Non-Blocking)') {
      steps {
        timeout(time: 5, unit: 'MINUTES') {
          script {
            def qg = waitForQualityGate abortPipeline: false
            echo "IaC Quality Gate result: ${qg.status}"
          }
        }
      }
    }

    // =========================================================
    // Security + Build + Deploy (same as your original)
    // =========================================================
    stage('TRIVY FS SCAN') {
      steps {
        sh '''
          trivy fs --no-progress --severity HIGH,CRITICAL . | tee trivyfs.txt
        '''
      }
    }

    stage('Docker Build & Push') {
      steps {
        script {
          withDockerRegistry(credentialsId: 'dockerhub') {
            sh '''
              docker build -t swiggy-clone .
              docker tag swiggy-clone ${DOCKER_IMAGE}
              docker push ${DOCKER_IMAGE}
            '''
          }
        }
      }
    }

    stage('TRIVY IMAGE SCAN') {
      steps {
        sh '''
          trivy image --no-progress --severity HIGH,CRITICAL \
          ${DOCKER_IMAGE} | tee trivyimage.txt
        '''
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        script {
          dir('Kubernetes') {
            kubeconfig(credentialsId: 'kubernetes', serverUrl: '') {
              sh 'kubectl delete --all pods'
              sh 'kubectl apply -f deployment.yml'
              sh 'kubectl apply -f service.yml'
            }
          }
        }
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'trivyfs.txt,trivyimage.txt', onlyIfSuccessful: false
    }
  }
}
